---
// src/pages/update-site.astro
---

<html lang="it">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Update Site</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        button {
            background: #007acc;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #005a9e;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group input {
            width: auto;
        }
        .result {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 4px;
            display: none;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aggiorna Sito</h1>
        
        <form id="updateSiteForm">
            <div class="form-group">
                <label for="siteId">ID Sito:</label>
                <input type="number" id="siteId" name="siteId" value="139" required>
            </div>

            <div class="form-group">
                <label for="title">Titolo:</label>
                <input type="text" id="title" name="title" value="Test Site" required>
            </div>

            <div class="form-group">
                <label for="url">URL:</label>
                <input type="url" id="url" name="url" value="https://my_example.com" required>
            </div>

            <div class="form-group">
                <label for="description">Descrizione:</label>
                <textarea id="description" name="description" rows="3">Test site created via API</textarea>
            </div>

            <div class="form-group">
                <label for="user_id">User ID:</label>
                <input type="text" id="user_id" name="user_id" value="9446217e-49e8-49f9-84dc-822ed8df969b" required>
            </div>

            <div class="form-group">
                <label for="type">Tipo:</label>
                <input type="text" id="type" name="type" value="example_type">
            </div>

            <div class="form-group">
                <label for="status_code">Status Code:</label>
                <input type="number" id="status_code" name="status_code" value="200">
            </div>

            <div class="form-group">
                <label for="id_area">ID Area:</label>
                <input type="number" id="id_area" name="id_area" value="1">
            </div>

            <div class="form-group">
                <label for="id_cat">ID Categoria:</label>
                <input type="number" id="id_cat" name="id_cat" value="1">
            </div>

            <div class="form-group">
                <label for="id_provider">ID Provider:</label>
                <input type="number" id="id_provider" name="id_provider" value="1">
            </div>

            <div class="form-group">
                <label for="ratings">Valutazioni:</label>
                <input type="number" id="ratings" name="ratings" value="4" min="1" max="5">
            </div>

            <div class="form-group">
                <label for="tag_3">Tag 3:</label>
                <input type="number" id="tag_3" name="tag_3" value="3">
            </div>

            <div class="form-group">
                <label for="tag_4">Tag 4:</label>
                <input type="number" id="tag_4" name="tag_4" value="4">
            </div>

            <div class="form-group">
                <label for="tag_5">Tag 5:</label>
                <input type="number" id="tag_5" name="tag_5" value="5">
            </div>

            <div class="form-group">
                <label for="AI_think">AI Think:</label>
                <textarea id="AI_think" name="AI_think" rows="2">AI analysis</textarea>
            </div>

            <div class="form-group">
                <label for="AI_summary">AI Summary:</label>
                <textarea id="AI_summary" name="AI_summary" rows="2">Summary generated by AI</textarea>
            </div>

            <!-- Checkboxes per i boolean -->
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="accessible" name="accessible" checked>
                    <label for="accessible">Accessibile</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="domain_exists" name="domain_exists" checked>
                    <label for="domain_exists">Dominio Esistente</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="html_content_exists" name="html_content_exists">
                    <label for="html_content_exists">Contenuto HTML Esistente</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="is_public" name="is_public" checked>
                    <label for="is_public">Pubblico</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="secure" name="secure" checked>
                    <label for="secure">Sicuro</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="valid_url" name="valid_url" checked>
                    <label for="valid_url">URL Valido</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="AI" name="AI">
                    <label for="AI">AI</label>
                </div>
            </div>

            <button type="submit" id="submitBtn">Aggiorna Sito</button>
        </form>

        <div id="result" class="result"></div>
    </div>

    <script>
        document.getElementById('updateSiteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Aggiornamento in corso...';
            resultDiv.style.display = 'none';
            
            try {
                // Get form data
                const formData = new FormData(this);
                const siteId = formData.get('siteId');
                
                // Build the data object
                const data = {
                    title: formData.get('title'),
                    url: formData.get('url'),
                    description: formData.get('description'),
                    user_id: formData.get('user_id'),
                    type: formData.get('type'),
                    status_code: parseInt(formData.get('status_code')),
                    id_area: parseInt(formData.get('id_area')),
                    id_cat: parseInt(formData.get('id_cat')),
                    id_provider: parseInt(formData.get('id_provider')),
                    ratings: parseInt(formData.get('ratings')),
                    tag_3: parseInt(formData.get('tag_3')),
                    tag_4: parseInt(formData.get('tag_4')),
                    tag_5: parseInt(formData.get('tag_5')),
                    AI_think: formData.get('AI_think'),
                    AI_summary: formData.get('AI_summary'),
                    // Boolean values
                    accessible: formData.has('accessible'),
                    domain_exists: formData.has('domain_exists'),
                    html_content_exists: formData.has('html_content_exists'),
                    is_public: formData.has('is_public'),
                    secure: formData.has('secure'),
                    valid_url: formData.has('valid_url'),
                    AI: formData.has('AI')
                };

                // Make the API call
                const response = await fetch('/api/v1/main/doQueries?type=updateSite', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateSite',
                        params: { id: siteId },
                        data: data
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>✅ Sito aggiornato con successo!</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    throw new Error(result.message || 'Errore durante l\'aggiornamento');
                }

            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>❌ Errore durante l'aggiornamento</h3>
                    <p>${error.message}</p>
                `;
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Aggiorna Sito';
                resultDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>